<!DOCTYPE html>
<html lang="en">
<head>
  <title>Login - The Scratch Channel</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/index-revamp.css">
  <link rel="stylesheet" href="../static/new.css">
  <link rel="stylesheet" href="../static/index.css">
</head>
<body>
  <div class="header">
    <p class="nav-logo">TSC</p>
    <nav class="nav-links">
      <a href="/">Home</a>
      <a href="articles.html">Articles</a>
      <a href="login.html">Log In</a>
    </nav>
  </div>  

  <div class="main">
    <button onclick="auth()">Login With ScratchAuth</button>
  </div>

  <script>
    // helps show detailed errs
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = block;
    }

    // helps clear detailed errs
    // idk why we need this it clears when the popup is closed, but pls keep so everything doesnt break
    function clearError() {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }
    
    async function auth() {
      window.location.href = `https://auth.itinerary.eu.org/auth?redirect=${btoa(window.location.href)}&name=The%20Scratch%20Channel`;

      const url = new URLSearchParams(window.location.search);
      const code = url.get('privateCode');

      if (code) {
        (async () => {
          try {
            const res = await fetch(`https://auth-api.itinerary.eu.org/auth/verifyToken/${code}`);
            const data = await res.json();
            const username = data.username;
            localStorage.setItem('user', username);

            const authResponse = await fetch('https://the-scratch-channel.onrender.com/api/auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username })
            });

            const authData = await authResponse.json();
            if (!authResponse.ok) {
              alert(authData.error || 'Authentication failed');
              return;
            }

            localStorage.setItem('authCode', authData.authCode);
            alert('Login successful!');

            const pfp = 'https://u.cubeupload.com/98pics/NewProject8svg2.png';
            const newUserResponse = await fetch('https://the-scratch-channel.onrender.com/api/new-user', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, pfp })
            });

            const newUserData = await newUserResponse.json();
            if (!newUserResponse.ok) {
              showError(newUserData.error || "Failed to create new user.");
              return;
            }

            window.location.href = 'articles.html';
            
          } catch (err) {
            console.error('Login failed:', err);
            alert('Error: Login failed. response from server:', err);
          }
        })();
      }
    });
  </script>
</body>
</html>
